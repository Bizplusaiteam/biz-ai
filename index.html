<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI OCR 服务器控制台</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6/dist/amazon-cognito-identity.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            margin: 0;
            min-height: 100vh;
            height: 100%;
            font-family: -apple-system, sans-serif;
            color: #333;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }

        /* Login overlay */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #f6f8fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            background: #fff;
            border: 1px solid #d1d5da;
            border-radius: 12px;
            padding: 32px;
            width: 360px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .login-box h2 { margin: 0 0 20px; font-size: 1.3rem; text-align: center; }
        .login-box label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .login-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 14px;
        }
        .login-box input:focus { outline: none; border-color: #0366d6; box-shadow: 0 0 0 3px rgba(3,102,214,0.15); }
        .login-box button {
            width: 100%;
            padding: 10px;
            background: #2ea44f;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .login-box button:hover { background: #2c974b; }
        .login-box button:disabled { opacity: 0.6; cursor: not-allowed; }
        .login-error { color: #cb2431; font-size: 13px; margin-bottom: 10px; display: none; }
        .login-info { color: #0366d6; font-size: 13px; margin-bottom: 10px; display: none; }

        .page-header {
            display: flex;
            align-items: stretch;
            gap: 12px;
            padding: 10px 14px;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            min-height: 0;
        }
        .page-header h1 { margin: 0; font-size: 1.2rem; font-weight: 600; white-space: nowrap; }
        .status-box {
            background: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid #d1d5da;
            align-self: center;
            flex-shrink: 0;
        }
        .controls { display: flex; gap: 6px; flex-shrink: 0; align-self: center; }
        button {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-start { background-color: #2ea44f; color: white; }
        .btn-stop { background-color: #cb2431; color: white; }
        .btn-refresh { background-color: #0366d6; color: white; }
        .btn-logout { background-color: #6a737d; color: white; font-size: 11px; padding: 4px 8px; }

        #logs {
            flex: 1;
            min-width: 0;
            background: #24292e;
            color: #e1e4e8;
            padding: 6px 10px;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-radius: 6px;
        }

        .dify-section {
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .dify-iframe-container {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            background: #f9fafb;
            position: relative;
            height: 100%;
        }
        #difyIframe {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background: #fff;
        }
        .dify-placeholder {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 16px;
            background: #f9fafb;
        }
        .dify-placeholder.hidden { display: none !important; }
        #difyIframe { z-index: 1; }
        .dify-placeholder .icon { font-size: 48px; margin-bottom: 15px; }
        .dify-fallback {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            z-index: 4;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            background: #f0f4f8;
            padding: 24px;
            text-align: center;
        }
        .dify-fallback.visible { display: flex; }
        .dify-fallback p { margin: 0; color: #374151; font-size: 15px; }
        .dify-fallback-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .dify-fallback-btns a {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            font-size: 14px;
        }
        .dify-fallback-btns a.primary { background: #0366d6; color: #fff; }
        .dify-fallback-btns a.secondary { background: #e5e7eb; color: #374151; }
    </style>
</head>
<body>

    <!-- Login overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>AI OCR 服务器控制台</h2>
            <div id="loginError" class="login-error"></div>
            <div id="loginInfo" class="login-info"></div>
            <div id="loginForm">
                <label for="loginEmail">邮箱</label>
                <input type="email" id="loginEmail" placeholder="you@bizplus-inc.com">
                <label for="loginPassword">密码</label>
                <input type="password" id="loginPassword" placeholder="请输入密码">
                <button id="loginBtn" onclick="doLogin()">登录</button>
            </div>
            <div id="newPwForm" style="display:none;">
                <label for="newPassword">设置新密码</label>
                <input type="password" id="newPassword" placeholder="新密码（8位以上）">
                <button id="newPwBtn" onclick="doSetNewPassword()">确认修改</button>
            </div>
        </div>
    </div>

    <header class="page-header">
        <h1>AI OCR 服务器控制台</h1>
        <div id="statusDisplay" class="status-box">检测中...</div>
        <div class="controls">
            <button onclick="checkStatus()" class="btn-refresh">刷新状态</button>
            <button onclick="controlServer('start')" class="btn-start">启动</button>
            <button onclick="controlServer('stop')" class="btn-stop">停止</button>
            <button onclick="doLogout()" class="btn-logout">登出</button>
        </div>
        <div id="logs"></div>
    </header>

    <main id="difySection" class="dify-section">
        <div class="dify-iframe-container">
            <div id="difyPlaceholder" class="dify-placeholder">
                <div class="icon">⏳</div>
                <div>正在加载 AI 分析工具...</div>
            </div>
            <iframe id="difyIframe" title="Dify AI 工作流" allow="clipboard-read; clipboard-write" width="100%" height="100%"></iframe>
            <div id="difyFallback" class="dify-fallback">
                <p>若上方未显示 Dify 工作流（被浏览器或网站限制嵌入），请选择下方方式打开：</p>
                <div class="dify-fallback-btns">
                    <a id="difyOpenSame" href="#" class="primary">在本页打开 Dify 工作流</a>
                    <a id="difyOpenNew" href="#" target="_blank" rel="noopener" class="secondary">在新标签页打开</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 配置区域
        // ==========================================

        const API_ENDPOINT = 'https://u1cj6rsil4.execute-api.ap-northeast-1.amazonaws.com/prod/server-control';

        const COGNITO_USER_POOL_ID = 'ap-northeast-1_QUAsebRwA';
        const COGNITO_CLIENT_ID = '3lcpua2fddokqtkdbps7cha1rd';

        const DIFY_EMBED_URL = 'https://udify.app/workflow/AEVEalXQRsh4bmEi';

        // ==========================================
        // Cognito 认证
        // ==========================================

        const poolData = {
            UserPoolId: COGNITO_USER_POOL_ID,
            ClientId: COGNITO_CLIENT_ID
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        let cognitoUser = null;
        let pendingNewPasswordCallback = null;
        let sessionCheckInterval = null;

        function getIdToken() {
            var user = userPool.getCurrentUser();
            if (!user) return null;
            return new Promise(function(resolve) {
                user.getSession(function(err, session) {
                    if (err || !session || !session.isValid()) { resolve(null); return; }
                    resolve(session.getIdToken().getJwtToken());
                });
            });
        }

        function doLogin() {
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var errorDiv = document.getElementById('loginError');
            var infoDiv = document.getElementById('loginInfo');
            var btn = document.getElementById('loginBtn');
            errorDiv.style.display = 'none';
            infoDiv.style.display = 'none';

            if (!email || !password) {
                errorDiv.textContent = '请输入邮箱和密码';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = '登录中...';

            var authDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                Username: email,
                Password: password
            });
            cognitoUser = new AmazonCognitoIdentity.CognitoUser({
                Username: email,
                Pool: userPool
            });

            cognitoUser.authenticateUser(authDetails, {
                onSuccess: function(result) {
                    // 单会话: 撤销所有其他会话，再重新认证
                    cognitoUser.globalSignOut({
                        onSuccess: function() {
                            var freshUser = new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });
                            freshUser.authenticateUser(authDetails, {
                                onSuccess: function() {
                                    cognitoUser = freshUser;
                                    btn.disabled = false;
                                    btn.textContent = '登录';
                                    onLoginSuccess();
                                },
                                onFailure: function() {
                                    btn.disabled = false;
                                    btn.textContent = '登录';
                                    onLoginSuccess();
                                }
                            });
                        },
                        onFailure: function() {
                            btn.disabled = false;
                            btn.textContent = '登录';
                            onLoginSuccess();
                        }
                    });
                },
                onFailure: function(err) {
                    btn.disabled = false;
                    btn.textContent = '登录';
                    errorDiv.textContent = err.message || '登录失败';
                    errorDiv.style.display = 'block';
                },
                newPasswordRequired: function(userAttributes, requiredAttributes) {
                    btn.disabled = false;
                    btn.textContent = '登录';
                    pendingNewPasswordCallback = { userAttributes: userAttributes };
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('newPwForm').style.display = 'block';
                    infoDiv.textContent = '首次登录，请设置新密码';
                    infoDiv.style.display = 'block';
                }
            });
        }

        function doSetNewPassword() {
            var newPw = document.getElementById('newPassword').value;
            var errorDiv = document.getElementById('loginError');
            var btn = document.getElementById('newPwBtn');
            errorDiv.style.display = 'none';

            if (!newPw || newPw.length < 8) {
                errorDiv.textContent = '密码至少8个字符';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = '设置中...';

            cognitoUser.completeNewPasswordChallenge(newPw, {}, {
                onSuccess: function(result) {
                    btn.disabled = false;
                    btn.textContent = '确认修改';
                    onLoginSuccess();
                },
                onFailure: function(err) {
                    btn.disabled = false;
                    btn.textContent = '确认修改';
                    errorDiv.textContent = err.message || '密码设置失败';
                    errorDiv.style.display = 'block';
                }
            });
        }

        function onLoginSuccess() {
            document.getElementById('loginOverlay').classList.add('hidden');
            log('[认证] 登录成功');
            checkStatus();
            // 每5分钟检查会话有效性（被其他设备踢出时自动登出）
            if (sessionCheckInterval) clearInterval(sessionCheckInterval);
            sessionCheckInterval = setInterval(validateSession, 5 * 60 * 1000);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    initDifySection();
                });
            });
        }

        function validateSession() {
            var user = userPool.getCurrentUser();
            if (!user) { forceLogout('会话不存在'); return; }
            user.getSession(function(err, session) {
                if (err || !session || !session.isValid()) {
                    forceLogout('会话已失效（可能已在其他设备登录）');
                }
            });
        }

        function forceLogout(reason) {
            if (sessionCheckInterval) { clearInterval(sessionCheckInterval); sessionCheckInterval = null; }
            var user = userPool.getCurrentUser();
            if (user) user.signOut();
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('newPwForm').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginInfo').style.display = 'none';
            document.getElementById('loginPassword').value = '';
            log('[认证] ' + reason + '，请重新登录');
        }

        function doLogout() {
            if (sessionCheckInterval) { clearInterval(sessionCheckInterval); sessionCheckInterval = null; }
            var user = userPool.getCurrentUser();
            if (user) {
                user.globalSignOut({
                    onSuccess: function() { log('[认证] 已全局登出'); },
                    onFailure: function() { user.signOut(); }
                });
            }
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('newPwForm').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginInfo').style.display = 'none';
            document.getElementById('loginPassword').value = '';
            log('[认证] 已登出');
        }

        // ==========================================
        // 主逻辑
        // ==========================================

        let currentServerStatus = null;

        async function callLambda(action) {
            var statusDiv = document.getElementById('statusDisplay');
            log('[发送请求] Action: ' + action + '...');

            try {
                var token = await getIdToken();
                if (!token) {
                    log('[错误] 未登录或 token 已过期，请重新登录');
                    doLogout();
                    return null;
                }

                var response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ action: action })
                });

                if (response.status === 401) {
                    log('[错误] 认证失败 (401)，请重新登录');
                    doLogout();
                    return null;
                }

                var data = await response.json();

                if (!response.ok) {
                    var errMsg = data.error || ('HTTP error ' + response.status);
                    statusDiv.innerHTML = '<span style="color:#cb2431">' + errMsg + '</span>';
                    log('[错误] ' + errMsg);
                    return null;
                }

                if (data.status) {
                    var statusText = data.status.toUpperCase();
                    var color = '#333';

                    if (statusText === 'RUNNING') color = '#2ea44f';
                    else if (statusText === 'STOPPED') color = '#cb2431';
                    else if (statusText === 'PENDING' || statusText === 'STOPPING') color = '#dbab09';

                    var ipInfo = data.ip && data.ip !== 'N/A' ? ' (IP: ' + data.ip + ')' : '';
                    statusDiv.innerHTML = '<span style="color:' + color + '">' + statusText + '</span>' + ipInfo;
                    currentServerStatus = statusText;
                }

                log('[响应成功] ' + JSON.stringify(data));
                return data;

            } catch (error) {
                console.error('API Error:', error);
                statusDiv.innerHTML = '<span style="color:#cb2431">连接失败</span>';
                log('[错误] ' + error.message);
                return null;
            }
        }

        function initDifySection() {
            var difySection = document.getElementById('difySection');
            var difyIframe = document.getElementById('difyIframe');
            var difyPlaceholder = document.getElementById('difyPlaceholder');

            difySection.style.display = 'block';
            if (!difyIframe.src) {
                difyIframe.style.display = 'block';
                difyIframe.src = DIFY_EMBED_URL;
                difyIframe.onload = function() {
                    window._difyIframeLoaded = true;
                    difyPlaceholder.classList.add('hidden');
                    log('[Dify] AI分析工具已加载完成');
                };
                difyIframe.onerror = function() {
                    difyPlaceholder.classList.add('hidden');
                    difyPlaceholder.innerHTML = '<div class="icon">X</div><div>AI分析工具加载失败</div><small style="margin-top:10px;">请检查DIFY_EMBED_URL配置</small>';
                    difyPlaceholder.classList.remove('hidden');
                    log('[Dify错误] iframe加载失败');
                };
                setTimeout(function() {
                    if (!difyPlaceholder.classList.contains('hidden')) {
                        difyPlaceholder.classList.add('hidden');
                        log('[Dify] 已显示嵌入页面');
                    }
                    showDifyFallbackLink();
                    if (!window._difyIframeLoaded) {
                        var fb = document.getElementById('difyFallback');
                        if (fb) fb.classList.add('visible');
                    }
                }, 8000);
            }
        }

        function showDifyFallbackLink() {
            var container = document.querySelector('.dify-iframe-container');
            if (!container || document.getElementById('difyFallbackLink')) return;
            var a = document.createElement('a');
            a.id = 'difyFallbackLink';
            a.href = DIFY_EMBED_URL;
            a.target = '_blank';
            a.rel = 'noopener';
            a.style.cssText = 'position:absolute;bottom:12px;right:12px;z-index:3;padding:8px 12px;background:#24292e;color:#e1e4e8;border-radius:6px;font-size:12px;text-decoration:none;';
            a.textContent = '在新标签页打开 Dify';
            container.appendChild(a);
        }

        function controlServer(action) {
            if (!confirm('确定要执行 ' + action.toUpperCase() + ' 操作吗？')) return;
            callLambda(action);
        }

        function checkStatus() {
            callLambda('status');
        }

        function log(msg) {
            var logDiv = document.getElementById('logs');
            var time = new Date().toLocaleTimeString();
            logDiv.innerText = '[' + time + '] ' + msg + '\n' + logDiv.innerText;
        }

        // Page init: check for existing session
        window.onload = function() {
            var openSame = document.getElementById('difyOpenSame');
            var openNew = document.getElementById('difyOpenNew');
            if (openSame) { openSame.href = DIFY_EMBED_URL; openSame.onclick = function(e) { e.preventDefault(); window.location.href = DIFY_EMBED_URL; }; }
            if (openNew) openNew.href = DIFY_EMBED_URL;

            // Check existing Cognito session
            var user = userPool.getCurrentUser();
            if (user) {
                user.getSession(function(err, session) {
                    if (!err && session && session.isValid()) {
                        onLoginSuccess();
                    }
                });
            }

            // Allow Enter key to submit login
            document.getElementById('loginPassword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') doLogin();
            });
            document.getElementById('newPassword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') doSetNewPassword();
            });
        };
    </script>
</body>
</html>
