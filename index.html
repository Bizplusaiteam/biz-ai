<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI OCR æœåŠ¡å™¨æ§åˆ¶å°</title>
    <style>
        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            margin: 0;
            min-height: 100vh;
            height: 100%;
            font-family: -apple-system, sans-serif;
            color: #333;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }
        
        .page-header {
            display: flex;
            align-items: stretch;
            gap: 12px;
            padding: 10px 14px;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            min-height: 0;
        }
        .page-header h1 { margin: 0; font-size: 1.2rem; font-weight: 600; white-space: nowrap; }
        .status-box {
            background: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid #d1d5da;
            align-self: center;
            flex-shrink: 0;
        }
        .controls { display: flex; gap: 6px; flex-shrink: 0; align-self: center; }
        button {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-start { background-color: #2ea44f; color: white; }
        .btn-stop { background-color: #cb2431; color: white; }
        .btn-refresh { background-color: #0366d6; color: white; }
        
        #logs {
            flex: 1;
            min-width: 0;
            background: #24292e;
            color: #e1e4e8;
            padding: 6px 10px;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-radius: 6px;
        }
        
        .dify-section {
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .dify-iframe-container {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            background: #f9fafb;
            position: relative;
            height: 100%;
        }
        #difyIframe {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background: #fff;
        }
        .dify-placeholder {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 16px;
            background: #f9fafb;
        }
        .dify-placeholder.hidden { display: none !important; }
        #difyIframe { z-index: 1; }
        .dify-placeholder .icon { font-size: 48px; margin-bottom: 15px; }
        .dify-fallback {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            z-index: 4;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            background: #f0f4f8;
            padding: 24px;
            text-align: center;
        }
        .dify-fallback.visible { display: flex; }
        .dify-fallback p { margin: 0; color: #374151; font-size: 15px; }
        .dify-fallback-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .dify-fallback-btns a {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            font-size: 14px;
        }
        .dify-fallback-btns a.primary { background: #0366d6; color: #fff; }
        .dify-fallback-btns a.secondary { background: #e5e7eb; color: #374151; }
    </style>
</head>
<body>

    <header class="page-header">
        <h1>ğŸš€ AI OCR æœåŠ¡å™¨æ§åˆ¶å°</h1>
        <div id="statusDisplay" class="status-box">æ£€æµ‹ä¸­...</div>
        <div class="controls">
            <button onclick="checkStatus()" class="btn-refresh">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            <button onclick="controlServer('start')" class="btn-start">â–¶ï¸ å¯åŠ¨</button>
            <button onclick="controlServer('stop')" class="btn-stop">â¹ï¸ åœæ­¢</button>
        </div>
        <div id="logs"></div>
    </header>

    <main id="difySection" class="dify-section">
        <div class="dify-iframe-container">
            <div id="difyPlaceholder" class="dify-placeholder">
                <div class="icon">â³</div>
                <div>æ­£åœ¨åŠ è½½ AI åˆ†æå·¥å…·...</div>
            </div>
            <iframe id="difyIframe" title="Dify AI å·¥ä½œæµ" allow="clipboard-read; clipboard-write" width="100%" height="100%"></iframe>
            <div id="difyFallback" class="dify-fallback">
                <p>è‹¥ä¸Šæ–¹æœªæ˜¾ç¤º Dify å·¥ä½œæµï¼ˆè¢«æµè§ˆå™¨æˆ–ç½‘ç«™é™åˆ¶åµŒå…¥ï¼‰ï¼Œè¯·é€‰æ‹©ä¸‹æ–¹æ–¹å¼æ‰“å¼€ï¼š</p>
                <div class="dify-fallback-btns">
                    <a id="difyOpenSame" href="#" class="primary">åœ¨æœ¬é¡µæ‰“å¼€ Dify å·¥ä½œæµ</a>
                    <a id="difyOpenNew" href="#" target="_blank" rel="noopener" class="secondary">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // ğŸ”§ é…ç½®åŒºåŸŸ (éƒ¨ç½²å‰åªéœ€ä¿®æ”¹è¿™é‡Œ)
        // ==========================================
        
        // 1. API Gateway çš„ Invoke URL (ä» AWS æ§åˆ¶å°è·å–)
        // æ ¼å¼é€šå¸¸æ˜¯: https://xxxxxx.execute-api.us-east-1.amazonaws.com/prod/server-control
        const API_ENDPOINT = 'https://YOUR_API_ID.execute-api.YOUR_REGION.amazonaws.com/prod/server-control';
        
        // 2. Dify å·¥ä½œæµåµŒå…¥ URL (ä» Dify Cloud æ§åˆ¶å°è·å–)
        // æ ¼å¼é€šå¸¸æ˜¯: https://cloud.dify.ai/workflows/YOUR_WORKFLOW_ID/embed?theme=light&language=zh-CN
        //const DIFY_EMBED_URL = 'https://cloud.dify.ai/workflows/YOUR_WORKFLOW_ID/embed?theme=light&language=zh-CN';
        const DIFY_EMBED_URL = 'https://udify.app/workflow/AEVEalXQRsh4bmEi';
        
        // 3. (å¯é€‰) å¦‚æœåœ¨ API Gateway å¼€å¯äº† API Key éªŒè¯ï¼Œè¯·å¡«å…¥
        const API_KEY = ''; 

        // ==========================================
        // ğŸš€ é€»è¾‘åŒºåŸŸ
        // ==========================================

        // å…¨å±€çŠ¶æ€è·Ÿè¸ª
        let currentServerStatus = null;

        async function callLambda(action) {
            const statusDiv = document.getElementById('statusDisplay');
            const logDiv = document.getElementById('logs');
            
            log(`[å‘é€è¯·æ±‚] Action: ${action}...`);

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (API_KEY) {
                    headers['x-api-key'] = API_KEY;
                }

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action: action })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // æ›´æ–°UIå’ŒçŠ¶æ€
                if (data.status) {
                    const statusText = data.status.toUpperCase();
                    let color = '#333';
                    
                    if (statusText === 'RUNNING') color = '#2ea44f';
                    else if (statusText === 'STOPPED') color = '#cb2431';
                    else if (statusText === 'PENDING' || statusText === 'STOPPING') color = '#dbab09';
                    
                    const ipInfo = data.ip && data.ip !== 'N/A' ? ` (IP: ${data.ip})` : '';
                    statusDiv.innerHTML = `<span style="color:${color}">${statusText}</span>${ipInfo}`;
                    
                    // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆDify åŒºåŸŸå½“å‰é»˜è®¤å¸¸æ˜¾ï¼Œä¸éšçŠ¶æ€åˆ‡æ¢ï¼‰
                    currentServerStatus = statusText;
                }
                
                log(`[å“åº”æˆåŠŸ] ${JSON.stringify(data)}`);
                return data;

            } catch (error) {
                console.error('API Error:', error);
                statusDiv.innerHTML = '<span style="color:#cb2431">âš ï¸ è¿æ¥å¤±è´¥</span>';
                log(`[é”™è¯¯] ${error.message}`);
                return null;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤º Dify åŒºåŸŸå¹¶åŠ è½½ iframeï¼ˆé»˜è®¤è¿›å…¥å³å¯ä½¿ç”¨ï¼‰
        function initDifySection() {
            const difySection = document.getElementById('difySection');
            const difyIframe = document.getElementById('difyIframe');
            const difyPlaceholder = document.getElementById('difyPlaceholder');
            
            difySection.style.display = 'block';
            if (!difyIframe.src) {
                // å…ˆæ˜¾ç¤º iframeï¼Œå ä½å±‚ç›–åœ¨ä¸Šé¢ï¼›è¿™æ · iframe å§‹ç»ˆå‚ä¸å¸ƒå±€ï¼ŒDify èƒ½æ­£ç¡®æ¸²æŸ“
                difyIframe.style.display = 'block';
                difyIframe.src = DIFY_EMBED_URL;
                difyIframe.onload = function() {
                    window._difyIframeLoaded = true;
                    difyPlaceholder.classList.add('hidden');
                    log('[Dify] AIåˆ†æå·¥å…·å·²åŠ è½½å®Œæˆ');
                    // åµŒå…¥æˆåŠŸåˆ™ä¸æ˜¾ç¤ºè§’æ ‡é“¾æ¥ï¼Œä¿æŒç•Œé¢å¹²å‡€
                };
                difyIframe.onerror = function() {
                    difyPlaceholder.classList.add('hidden');
                    difyPlaceholder.innerHTML = `
                        <div class="icon">âŒ</div>
                        <div>AIåˆ†æå·¥å…·åŠ è½½å¤±è´¥</div>
                        <small style="margin-top: 10px;">è¯·æ£€æŸ¥DIFY_EMBED_URLé…ç½®</small>
                    `;
                    difyPlaceholder.classList.remove('hidden');
                    log('[Difyé”™è¯¯] iframeåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥DIFY_EMBED_URLé…ç½®');
                };
                // è‹¥ 8 ç§’åä»æœª onloadï¼Œéšè—å ä½å±‚å¹¶æ˜¾ç¤ºå¤‡ç”¨å…¥å£ï¼ˆé“¾æ¥ + å¤§é¢æ¿ï¼‰
                setTimeout(function() {
                    if (!difyPlaceholder.classList.contains('hidden')) {
                        difyPlaceholder.classList.add('hidden');
                        log('[Dify] å·²æ˜¾ç¤ºåµŒå…¥é¡µé¢ï¼ˆè‹¥ä»ç©ºç™½è¯·æ£€æŸ¥ç½‘ç»œæˆ– DIFY_EMBED_URLï¼‰');
                    }
                    showDifyFallbackLink();
                    if (!window._difyIframeLoaded) {
                        var fb = document.getElementById('difyFallback');
                        if (fb) fb.classList.add('visible');
                    }
                }, 8000);
            }
        }
        function showDifyFallbackLink() {
            var container = document.querySelector('.dify-iframe-container');
            if (!container || document.getElementById('difyFallbackLink')) return;
            var a = document.createElement('a');
            a.id = 'difyFallbackLink';
            a.href = DIFY_EMBED_URL;
            a.target = '_blank';
            a.rel = 'noopener';
            a.style.cssText = 'position:absolute;bottom:12px;right:12px;z-index:3;padding:8px 12px;background:#24292e;color:#e1e4e8;border-radius:6px;font-size:12px;text-decoration:none;';
            a.textContent = 'åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ Dify';
            container.appendChild(a);
        }

        function controlServer(action) {
            if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ ${action.toUpperCase()} æ“ä½œå—ï¼Ÿ`)) return;
            callLambda(action);
        }

        function checkStatus() {
            callLambda('status');
        }

        function log(msg) {
            const logDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logDiv.innerText = `[${time}] ${msg}\n` + logDiv.innerText;
        }

        // é¡µé¢åŠ è½½æ—¶ï¼šç­‰å¸ƒå±€ç¨³å®šåå†åŠ è½½ iframeï¼Œå¹¶æ£€æŸ¥ EC2 çŠ¶æ€
        window.onload = function() {
            var openSame = document.getElementById('difyOpenSame');
            var openNew = document.getElementById('difyOpenNew');
            if (openSame) { openSame.href = DIFY_EMBED_URL; openSame.onclick = function(e) { e.preventDefault(); window.location.href = DIFY_EMBED_URL; }; }
            if (openNew) openNew.href = DIFY_EMBED_URL;
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    initDifySection();
                });
            });
            checkStatus();
        };
    </script>
</body>
</html>